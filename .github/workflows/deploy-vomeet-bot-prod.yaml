name: Deploy vomeet-bot Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g., 'production' or short SHA like 'abc1234')"
        required: false
        default: "production"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/vomeet-bot
  NAMESPACE: vomeet-bot

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image exists
        env:
          TAG: ${{ inputs.image_tag }}
        run: |
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "âœ… Image exists: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG"
          else
            echo "âŒ Image not found: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG"
            exit 1
          fi

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.32.2'

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.16.4'

      - name: Create kubeconfig
        run: |
          mkdir -p ~/.kube
          cat > ~/.kube/config << EOF
          apiVersion: v1
          kind: Config
          clusters:
            - name: ${{ vars.KUBE_CLUSTER_NAME_PROD }}
              cluster:
                server: ${{ vars.KUBE_CLUSTER_URL_PROD }}
                certificate-authority-data: ${{ secrets.KUBE_CERTIFICATE_PROD }}
          contexts:
            - name: ${{ vars.KUBE_CLUSTER_NAME_PROD }}
              context:
                cluster: ${{ vars.KUBE_CLUSTER_NAME_PROD }}
                namespace: ${{ env.NAMESPACE }}
                user: vomeet-bot-admin
          users:
            - name: vomeet-bot-admin
              user:
                token: ${{ secrets.KUBE_TOKEN_PROD }}
          current-context: ${{ vars.KUBE_CLUSTER_NAME_PROD }}
          EOF
          chmod 600 ~/.kube/config

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Helm chart
        env:
          TAG: ${{ inputs.image_tag }}
        run: |
          helm upgrade --install vomeet-bot ./services/vomeet-bot/chart \
            --namespace ${{ env.NAMESPACE }} \
            --values ./services/vomeet-bot/chart/values.yaml \
            --set imageTag=$TAG \
            --set imageRepository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          echo "Checking deployed resources..."
          kubectl get serviceaccount -n ${{ env.NAMESPACE }}
          kubectl get roles -n ${{ env.NAMESPACE }}
          kubectl get rolebindings -n ${{ env.NAMESPACE }}
          echo "âœ… Deployment verified"

      - name: Cleanup kubeconfig
        if: always()
        run: rm -f ~/.kube/config

      - name: Send success notification to Telegram
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_THREAD_ID }}" \
            -d text="âœ… *[PRODUCTION] vomeet-bot Deployed*%0A%0AðŸ“¦ Namespace: ${{ env.NAMESPACE }}%0AðŸ·ï¸ Image Tag: ${{ inputs.image_tag }}%0AðŸ‘¤ Triggered by: ${{ github.actor }}%0Aâ° Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')%0AðŸ”— [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            -d parse_mode="Markdown"

      - name: Send failure notification to Telegram
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TELEGRAM_THREAD_ID }}" \
            -d text="âŒ *[PRODUCTION] vomeet-bot Deploy Failed*%0A%0AðŸ“¦ Namespace: ${{ env.NAMESPACE }}%0AðŸ·ï¸ Image Tag: ${{ inputs.image_tag }}%0AðŸ‘¤ Triggered by: ${{ github.actor }}%0Aâ° Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')%0AðŸ”— [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            -d parse_mode="Markdown"
